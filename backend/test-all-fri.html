<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ANM-FRI - Test Completo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .login-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            cursor: pointer;
            user-select: none;
        }

        .card h3:hover {
            color: #5568d3;
        }

        .form-container {
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .required {
            color: red;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .fri-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .fri-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .fri-item h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .fri-item p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-borrador {
            background: #ffc107;
            color: #000;
        }

        .badge-enviado {
            background: #17a2b8;
            color: white;
        }

        .badge-aprobado {
            background: #28a745;
            color: white;
        }

        .badge-rechazado {
            background: #dc3545;
            color: white;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üèîÔ∏è Sistema TU MINA - CTGLOBAL</h1>
            <p>Formularios de Reporte de Informaci√≥n - Agencia Nacional de Miner√≠a ANM</p>
            <div id="userInfo" class="user-info"></div>
            <div id="borradoresInfo" class="user-info" style="display: none; background: #fff3cd; border: 2px solid #ffc107;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>üìù Borradores pendientes:</strong> <span id="borradoresCount">0</span>
                    </div>
                    <button onclick="enviarTodosBorradores()" class="btn btn-primary" style="width: auto;">
                        üì§ ENVIAR TODOS LOS BORRADORES
                    </button>
                </div>
    </div>

        <!-- SECCI√ìN DE LOGIN -->
        <div id="loginSection" class="login-section">
            <h2 style="color: #667eea; margin-bottom: 20px;">üîê Iniciar Sesi√≥n</h2>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="email" placeholder="usuario@tumina.com" value="carlos.fajardo@tumina.com" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a:</label>
                    <input type="password" id="password" value="123456" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">INICIAR SESI√ìN</button>
            </form>
            <div id="loginResult" class="result"></div>
        </div>

        <!-- GRID DE FORMULARIOS -->
        <div id="formsGrid" class="grid" style="display: none;">
            
            <!-- ==================== FRI PRODUCCI√ìN ==================== -->
            <div class="card">
                <h3 onclick="toggleForm('formProduccion')">1Ô∏è‚É£ FRI Producci√≥n (Mensual) ‚ñº</h3>
                <div id="formProduccion" class="form-container">
                    <form onsubmit="submitForm(event, 'produccion')">
                        <div class="form-group">
                            <label>Mineral <span class="required">*</span></label>
                            <select name="mineral" required>
                                <option value="">Seleccione...</option>
                                <option value="Oro">Oro</option>
                                <option value="Plata">Plata</option>
                                <option value="Arena">Arena</option>
                                <option value="Grava">Grava</option>
                                <option value="Arcilla">Arcilla</option>
                                <option value="Caliza">Caliza</option>
                                <option value="Carbon">Carb√≥n</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Horas Operativas <span class="required">*</span></label>
                                <input type="number" name="horasOperativas" min="0" max="744" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Cantidad Producida <span class="required">*</span></label>
                                <input type="number" name="cantidadProducida" min="0" step="0.01" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Unidad de Medida <span class="required">*</span></label>
                            <select name="unidadMedida" required>
                                <option value="TONELADAS">Toneladas</option>
                                <option value="m3">Metros C√∫bicos (m¬≥)</option>
                                <option value="KG">Kilogramos</option>
                                <option value="GRAMOS">Gramos</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Material Entra Planta</label>
                                <input type="number" name="materialEntraPlanta" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Material Sale Planta</label>
                                <input type="number" name="materialSalePlanta" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Masa Unitaria</label>
                            <input type="number" name="masaUnitaria" min="0" step="0.01">
                        </div>

                        <div class="form-group">
                            <label>Observaciones</label>
                            <textarea name="observaciones" placeholder="Observaciones adicionales..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">‚úÖ CREAR FRI</button>
                            <button type="button" class="btn btn-info" onclick="listarFRI('produccion')">üìã LISTAR</button>
                            <button type="reset" class="btn btn-secondary">üîÑ LIMPIAR</button>
                        </div>
                    </form>
                    <div class="fri-list" id="listProduccion"></div>
                </div>
            </div>

            <!-- ==================== FRI INVENTARIOS ==================== -->
            <div class="card">
                <h3 onclick="toggleForm('formInventarios')">2Ô∏è‚É£ FRI Inventarios (Mensual) ‚ñº</h3>
                <div id="formInventarios" class="form-container">
                    <form onsubmit="submitForm(event, 'inventarios')">
                        <div class="form-group">
                            <label>Mineral <span class="required">*</span></label>
                            <select name="mineral" required>
                                <option value="">Seleccione...</option>
                                <option value="Oro">Oro</option>
                                <option value="Arena">Arena</option>
                                <option value="Grava">Grava</option>
                                <option value="Arcilla">Arcilla</option>
                                <option value="Caliza">Caliza</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Unidad de Medida <span class="required">*</span></label>
                            <select name="unidadMedida" required>
                                <option value="TONELADAS">Toneladas</option>
                                <option value="m3">Metros C√∫bicos (m¬≥)</option>
                                <option value="KG">Kilogramos</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Inventario Inicial Acopio <span class="required">*</span></label>
                                <input type="number" name="inventarioInicialAcopio" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Inventario Final Acopio <span class="required">*</span></label>
                                <input type="number" name="inventarioFinalAcopio" min="0" step="0.01" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Ingreso Acopio <span class="required">*</span></label>
                                <input type="number" name="ingresoAcopio" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Salida Acopio <span class="required">*</span></label>
                                <input type="number" name="salidaAcopio" min="0" step="0.01" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Observaciones</label>
                            <textarea name="observaciones" placeholder="Observaciones adicionales..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">‚úÖ CREAR FRI</button>
                            <button type="button" class="btn btn-info" onclick="listarFRI('inventarios')">üìã LISTAR</button>
                            <button type="reset" class="btn btn-secondary">üîÑ LIMPIAR</button>
                        </div>
                    </form>
                    <div class="fri-list" id="listInventarios"></div>
                </div>
            </div>

            <!-- ==================== FRI PARADAS ==================== -->
            <div class="card">
                <h3 onclick="toggleForm('formParadas')">3Ô∏è‚É£ FRI Paradas de Producci√≥n (Mensual) ‚ñº</h3>
                <div id="formParadas" class="form-container">
                    <form onsubmit="submitForm(event, 'paradas')">
                        <div class="form-group">
                            <label>Tipo de Parada <span class="required">*</span></label>
                            <select name="tipoParada" required>
                                <option value="">Seleccione...</option>
                                <option value="Programada">Programada</option>
                                <option value="No programada">No programada</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                                <option value="Clima">Clima</option>
                                <option value="Falta de insumos">Falta de insumos</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha de Inicio <span class="required">*</span></label>
                                <input type="datetime-local" name="fechaInicio" required>
                            </div>
                            <div class="form-group">
                                <label>Fecha de Fin</label>
                                <input type="datetime-local" name="fechaFin">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Horas de Parada <span class="required">*</span></label>
                            <input type="number" name="horasParadas" min="0" step="0.1" required>
                        </div>

                        <div class="form-group">
                            <label>Motivo de la Parada <span class="required">*</span></label>
                            <textarea name="motivo" placeholder="Describa el motivo de la parada..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label>Observaciones</label>
                            <textarea name="observaciones" placeholder="Observaciones adicionales..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">‚úÖ CREAR FRI</button>
                            <button type="button" class="btn btn-info" onclick="listarFRI('paradas')">üìã LISTAR</button>
                            <button type="reset" class="btn btn-secondary">üîÑ LIMPIAR</button>
                        </div>
                    </form>
                    <div class="fri-list" id="listParadas"></div>
                </div>
            </div>

            <!-- ==================== FRI EJECUCI√ìN ==================== -->
            <div class="card">
                <h3 onclick="toggleForm('formEjecucion')">4Ô∏è‚É£ FRI Ejecuci√≥n (Mensual) ‚ñº</h3>
                <div id="formEjecucion" class="form-container">
                    <form onsubmit="submitForm(event, 'ejecucion')">
                        <div class="form-group">
                            <label>Mineral <span class="required">*</span></label>
                            <select name="mineral" required>
                                <option value="">Seleccione...</option>
                                <option value="Oro">Oro</option>
                                <option value="Arena">Arena</option>
                                <option value="Grava">Grava</option>
                                <option value="Arcilla">Arcilla</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Denominaci√≥n del Frente <span class="required">*</span></label>
                            <input type="text" name="denominacionFrente" placeholder="Ej: Frente A" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Latitud <span class="required">*</span></label>
                                <input type="number" name="latitud" step="0.00000001" placeholder="Ej: 4.60971" required>
                            </div>
                            <div class="form-group">
                                <label>Longitud <span class="required">*</span></label>
                                <input type="number" name="longitud" step="0.00000001" placeholder="Ej: -74.08175" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>M√©todo de Explotaci√≥n <span class="required">*</span></label>
                            <select name="metodoExplotacion" required>
                                <option value="">Seleccione...</option>
                                <option value="Cielo abierto">Cielo abierto</option>
                                <option value="Subterr√°neo">Subterr√°neo</option>
                                <option value="Aluvi√≥n">Aluvi√≥n</option>
                                <option value="Dragado">Dragado</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Avance Ejecutado <span class="required">*</span></label>
                                <input type="number" name="avanceEjecutado" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Unidad de Medida <span class="required">*</span></label>
                                <select name="unidadMedidaAvance" required>
                                    <option value="m">Metros (m)</option>
                                    <option value="m2">Metros cuadrados (m¬≤)</option>
                                    <option value="m3">Metros c√∫bicos (m¬≥)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Volumen Ejecutado <span class="required">*</span></label>
                            <input type="number" name="volumenEjecutado" min="0" step="0.01" required>
                        </div>

                        <div class="form-group">
                            <label>Observaciones</label>
                            <textarea name="observaciones" placeholder="Observaciones adicionales..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">‚úÖ CREAR FRI</button>
                            <button type="button" class="btn btn-info" onclick="listarFRI('ejecucion')">üìã LISTAR</button>
                            <button type="reset" class="btn btn-secondary">üîÑ LIMPIAR</button>
                        </div>
                    </form>
                    <div class="fri-list" id="listEjecucion"></div>
                </div>
            </div>

            <!-- ==================== FRI MAQUINARIA Y TRANSPORTE ==================== -->
            <div class="card">
                <h3 onclick="toggleForm('formMaquinaria')">5Ô∏è‚É£ FRI Maquinaria y Transporte (Mensual) ‚ñº</h3>
                <div id="formMaquinaria" class="form-container">
                    <form onsubmit="submitForm(event, 'maquinaria')">
                        <div class="form-group">
                            <label>Tipo de Maquinaria <span class="required">*</span></label>
                            <select name="tipoMaquinaria" required>
                                <option value="">Seleccione...</option>
                                <option value="Retroexcavadora">Retroexcavadora</option>
                                <option value="Bulldozer">Bulldozer</option>
                                <option value="Volqueta">Volqueta</option>
                                <option value="Cargador">Cargador</option>
                                <option value="Excavadora">Excavadora</option>
                                <option value="Motoniveladora">Motoniveladora</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Cantidad <span class="required">*</span></label>
                                <input type="number" name="cantidad" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Horas de Operaci√≥n <span class="required">*</span></label>
                                <input type="number" name="horasOperacion" min="0" step="0.1" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Capacidad de Transporte</label>
                                <input type="number" name="capacidadTransporte" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Unidad de Capacidad</label>
                                <select name="unidadCapacidad">
                                    <option value="TONELADAS">Toneladas</option>
                                    <option value="m3">Metros C√∫bicos (m¬≥)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Observaciones</label>
                            <textarea name="observaciones" placeholder="Observaciones adicionales..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">‚úÖ CREAR FRI</button>
                            <button type="button" class="btn btn-info" onclick="listarFRI('maquinaria')">üìã LISTAR</button>
                            <button type="reset" class="btn btn-secondary">üîÑ LIMPIAR</button>
                        </div>
                    </form>
                    <div class="fri-list" id="listMaquinaria"></div>
                </div>
            </div>

            <!-- ==================== FRI REGAL√çAS ==================== -->
            <div class="card">
                <h3 onclick="toggleForm('formRegalias')">6Ô∏è‚É£ FRI Regal√≠as (Trimestral) ‚ñº</h3>
                <div id="formRegalias" class="form-container">
                    <form onsubmit="submitForm(event, 'regalias')">
                        <div class="form-group">
                            <label>Mineral <span class="required">*</span></label>
                            <select name="mineral" required>
                                <option value="">Seleccione...</option>
                                <option value="Oro">Oro</option>
                                <option value="Plata">Plata</option>
                                <option value="Arena">Arena</option>
                                <option value="Grava">Grava</option>
                                <option value="Arcilla">Arcilla</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Cantidad Extra√≠da <span class="required">*</span></label>
                                <input type="number" name="cantidadExtraida" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Unidad de Medida <span class="required">*</span></label>
                                <select name="unidadMedida" required>
                                    <option value="TONELADAS">Toneladas</option>
                                    <option value="m3">Metros C√∫bicos (m¬≥)</option>
                                    <option value="KG">Kilogramos</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Valor de Declaraci√≥n ($) <span class="required">*</span></label>
                                <input type="number" name="valorDeclaracion" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Valor Contraprestaciones ($)</label>
                                <input type="number" name="valorContraprestaciones" min="0" step="0.01">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Resoluci√≥n UPME</label>
                            <input type="text" name="resolucionUPME" placeholder="N√∫mero de resoluci√≥n UPME">
                        </div>

                        <div class="form-group">
                            <label>Observaciones</label>
                            <textarea name="observaciones" placeholder="Observaciones adicionales..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">‚úÖ CREAR FRI</button>
                            <button type="button" class="btn btn-info" onclick="listarFRI('regalias')">üìã LISTAR</button>
                            <button type="reset" class="btn btn-secondary">üîÑ LIMPIAR</button>
                        </div>
                    </form>
                    <div class="fri-list" id="listRegalias"></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let authToken = null;
        let currentUser = null;

        // ==================== FUNCIONES DE AUTENTICACI√ìN ====================
        async function login(event) {
        event.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const resultDiv = document.getElementById('loginResult');

        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (data.success) {
                authToken = data.token;
                currentUser = data.usuario;
                localStorage.setItem('authToken', authToken);
                
                // Mostrar info del usuario
                const userInfo = document.getElementById('userInfo');
                userInfo.innerHTML = `
                    <strong>üë§ Usuario:</strong> ${currentUser.nombre} (${currentUser.rol})<br>
                    <strong>üìß Email:</strong> ${currentUser.email}<br>
                    <strong>üèîÔ∏è T√≠tulo Minero:</strong> ${currentUser.tituloMinero?.numeroTitulo || 'N/A'} - ${currentUser.tituloMinero?.municipio || 'N/A'}
                    <button onclick="logout()" class="btn btn-danger" style="margin-top: 10px;">üö™ CERRAR SESI√ìN</button>
                `;
                userInfo.style.display = 'block';

                // Ocultar login y mostrar formularios
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('formsGrid').style.display = 'grid';

                // Cargar conteo de borradores
                await actualizarContadorBorradores();

                resultDiv.className = 'result success';
                resultDiv.textContent = '‚úÖ Login exitoso! Cargando formularios...';
                resultDiv.style.display = 'block';

                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 2000);

            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå ' + data.message;
                resultDiv.style.display = 'block';
            }

        } catch (error) {
            resultDiv.className = 'result error';
            resultDiv.textContent = '‚ùå Error de conexi√≥n: ' + error.message;
            resultDiv.style.display = 'block';
        }
    }

       async function logout() {
    if (!authToken) {
        return;
    }

    // Preguntar si quiere enviar borradores antes de cerrar sesi√≥n
    const borradoresResponse = await fetch(`${API_BASE}/fri/borradores/count`, {
        headers: {
            'Authorization': `Bearer ${authToken}`
        }
    });

    const borradoresData = await borradoresResponse.json();
    
    if (borradoresData.success && borradoresData.total > 0) {
        const confirmar = confirm(
            `‚ö†Ô∏è Tienes ${borradoresData.total} formulario(s) en BORRADOR.\n\n` +
            `¬øDeseas ENVIARLOS antes de cerrar sesi√≥n?\n\n` +
            `‚úÖ S√ç = Los borradores se enviar√°n autom√°ticamente\n` +
            `‚ùå NO = Los borradores quedar√°n guardados para despu√©s`
        );

        if (confirmar) {
            await enviarTodosBorradores();
        }
    }

    // Cerrar sesi√≥n
    authToken = null;
    currentUser = null;
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('formsGrid').style.display = 'none';
    document.getElementById('userInfo').style.display = 'none';
    document.getElementById('borradoresInfo').style.display = 'none';
}

async function actualizarContadorBorradores() {
    if (!authToken) return;

    try {
        const response = await fetch(`${API_BASE}/fri/borradores/count`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });

        const data = await response.json();

        if (data.success) {
            const borradoresInfo = document.getElementById('borradoresInfo');
            const countSpan = document.getElementById('borradoresCount');
            
            countSpan.textContent = data.total;
            
            if (data.total > 0) {
                borradoresInfo.style.display = 'block';
            } else {
                borradoresInfo.style.display = 'none';
            }
        }

    } catch (error) {
        console.error('Error al actualizar contador:', error);
    }
}

async function enviarTodosBorradores() {
    if (!authToken) {
        alert('‚ùå Debes iniciar sesi√≥n primero');
        return;
    }

    const confirmar = confirm('¬øEst√°s seguro de que deseas ENVIAR todos los borradores?\n\nEsto cambiar√° su estado y ya no podr√°s editarlos.');
    
    if (!confirmar) return;

    try {
        const response = await fetch(`${API_BASE}/fri/enviar-borradores`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('‚úÖ ' + data.message + '\n\nDetalles:\n' + 
                  `- Producci√≥n: ${data.detalles.produccion}\n` +
                  `- Inventarios: ${data.detalles.inventarios}\n` +
                  `- Paradas: ${data.detalles.paradas}\n` +
                  `- Ejecuci√≥n: ${data.detalles.ejecucion}\n` +
                  `- Maquinaria: ${data.detalles.maquinaria}\n` +
                  `- Regal√≠as: ${data.detalles.regalias}`
            );
            
            await actualizarContadorBorradores();
            
            // Recargar listas si est√°n abiertas
            document.querySelectorAll('.form-container.active').forEach(container => {
                const formId = container.id.replace('form', '').toLowerCase();
                if (formId) listarFRI(formId);
            });
            
        } else {
            alert('‚ùå Error: ' + data.message);
        }

    } catch (error) {
        alert('‚ùå Error de conexi√≥n: ' + error.message);
    }
}

async function cambiarEstadoFRI(tipo, id, nuevoEstado) {
    if (!authToken) {
        alert('‚ùå Debes iniciar sesi√≥n primero');
        return;
    }

    try {
        const response = await fetch(`${API_BASE}/fri/${tipo}/${id}/estado`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({ estado: nuevoEstado })
        });

        const data = await response.json();

        if (data.success) {
            alert('‚úÖ ' + data.message);
            await actualizarContadorBorradores();
            listarFRI(tipo);
        } else {
            alert('‚ùå Error: ' + data.message);
        }

    } catch (error) {
        alert('‚ùå Error de conexi√≥n: ' + error.message);
    }
}

        // ==================== FUNCIONES DE FORMULARIOS ====================
        function toggleForm(formId) {
            const form = document.getElementById(formId);
            form.classList.toggle('active');
        }

        async function submitForm(event, tipo) {
    event.preventDefault();

    if (!authToken) {
        alert('‚ùå Debes iniciar sesi√≥n primero');
        return;
    }

    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        const response = await fetch(`${API_BASE}/fri/${tipo}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            alert('‚úÖ ' + result.message);
            form.reset();
            await actualizarContadorBorradores(); // ‚¨ÖÔ∏è NUEVO
            listarFRI(tipo);
        } else {
            alert('‚ùå Error: ' + result.message);
        }

    } catch (error) {
        alert('‚ùå Error de conexi√≥n: ' + error.message);
    }
}

        async function listarFRI(tipo) {
    if (!authToken) {
        alert('‚ùå Debes iniciar sesi√≥n primero');
        return;
    }

    try {
        const response = await fetch(`${API_BASE}/fri/${tipo}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });

        const data = await response.json();

        if (data.success) {
            const listDiv = document.getElementById(`list${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            
            if (data.fris.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999;">No hay registros a√∫n</p>';
                return;
            }

            listDiv.innerHTML = data.fris.map(fri => `
                <div class="fri-item">
                    <h4>
                        <span class="badge badge-${fri.estado.toLowerCase()}">${fri.estado}</span>
                        ID: ${fri.id.substring(0, 8)}
                    </h4>
                    <p><strong>Creado:</strong> ${new Date(fri.createdAt).toLocaleString('es-CO')}</p>
                    <p><strong>Usuario:</strong> ${fri.usuario.nombre}</p>
                    ${fri.tituloMinero ? `<p><strong>T√≠tulo:</strong> ${fri.tituloMinero.numeroTitulo} - ${fri.tituloMinero.municipio}</p>` : ''}
                    ${fri.mineral ? `<p><strong>Mineral:</strong> ${fri.mineral}</p>` : ''}
                    ${fri.observaciones ? `<p><strong>Observaciones:</strong> ${fri.observaciones}</p>` : ''}
                    
                    ${fri.estado === 'BORRADOR' ? `
                        <button onclick="cambiarEstadoFRI('${tipo}', '${fri.id}', 'ENVIADO')" class="btn btn-primary" style="margin-top: 10px; font-size: 12px;">
                            üì§ ENVIAR
                        </button>
                    ` : ''}
                    
                    ${currentUser.rol === 'ADMIN' && fri.estado === 'ENVIADO' ? `
                        <button onclick="cambiarEstadoFRI('${tipo}', '${fri.id}', 'APROBADO')" class="btn btn-success" style="margin-top: 10px; font-size: 12px; margin-right: 5px;">
                            ‚úÖ APROBAR
                        </button>
                        <button onclick="cambiarEstadoFRI('${tipo}', '${fri.id}', 'RECHAZADO')" class="btn btn-danger" style="margin-top: 10px; font-size: 12px;">
                            ‚ùå RECHAZAR
                        </button>
                    ` : ''}
                </div>
            `).join('');
        } else {
            alert('‚ùå Error al listar: ' + data.message);
        }

    } catch (error) {
        alert('‚ùå Error de conexi√≥n: ' + error.message);
    }
}
    </script>
</body>
</html>