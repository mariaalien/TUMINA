<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exportador ANM - Sistema FRI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .tipo-formulario {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .tipo-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .tipo-item:hover {
            border-color: #667eea;
            background: #e7f0ff;
        }

        .tipo-item.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .tipo-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .tipo-item label {
            cursor: pointer;
            margin: 0;
            flex: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 500px;
            overflow-y: auto;
        }

        .preview-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            font-size: 13px;
        }

        .preview-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
        }

        .preview-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .preview-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 12px;
        }

        .preview-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .preview-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-enviado {
            background: #17a2b8;
            color: white;
        }

        .badge-aprobado {
            background: #28a745;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .vista-previa-documento {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #667eea;
        }

        .documento-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .documento-header h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .documento-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì§ Exportador Oficial ANM - Sistema FRI</h1>
            <p>Genera reportes en formato oficial para la Agencia Nacional de Miner√≠a</p>
            <button onclick="window.location.href='dashboard.html'" class="btn btn-info">
                ‚¨ÖÔ∏è Volver al Dashboard
            </button>
            <button onclick="window.location.href='test-all-fri.html'" class="btn btn-primary">
                üìù Ir a Formularios
            </button>
        </div>

        <!-- PASO 1: FILTROS -->
        <div class="card">
            <h3>üîç Paso 1: Filtros de Selecci√≥n</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Fecha Inicio:</label>
                    <input type="date" id="fechaInicio">
                </div>

                 <div class="form-group">
                    <label>Fecha Fin:</label>
                    <input type="date" id="fechaFin">
                </div>
                
                <div class="form-group">
                    <label>T√≠tulo Minero:</label>
                    <select id="tituloMinero">
                        <option value="">Todos</option>
                    </select>
                </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Mineral:</label>
                    <select id="mineral">
                        <option value="">Todos</option>
                        <option value="Oro">Oro</option>
                        <option value="Arena">Arena</option>
                        <option value="Grava">Grava</option>
                        <option value="Arcilla">Arcilla</option>
                        <option value="Caliza">Caliza</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Estado:</label>
                    <select id="estado">
                        <option value="">Todos</option>
                        <option value="ENVIADO">Enviado</option>
                        <option value="APROBADO">Aprobado</option>
                    </select>
                </div>
            </div>

            <button onclick="limpiarFiltros()" class="btn btn-secondary">
                üîÑ LIMPIAR FILTROS
            </button>
        </div>

        <!-- PASO 2: TIPOS DE FORMULARIO -->
        <div class="card">
            <h3>üìã Paso 2: Selecciona los Tipos de Formulario</h3>
            <p style="color: #666; margin-bottom: 15px;">Haz clic para seleccionar/deseleccionar</p>
            
            <div class="tipo-formulario">
                <div class="tipo-item selected" onclick="toggleTipo('produccion', this)">
                    <input type="checkbox" id="tipo-produccion" checked>
                    <label>FRI Producci√≥n (Mensual)</label>
                </div>
                <div class="tipo-item selected" onclick="toggleTipo('inventarios', this)">
                    <input type="checkbox" id="tipo-inventarios" checked>
                    <label>FRI Inventarios (Mensual)</label>
                </div>
                <div class="tipo-item selected" onclick="toggleTipo('paradas', this)">
                    <input type="checkbox" id="tipo-paradas" checked>
                    <label>FRI Paradas de Producci√≥n</label>
                </div>
                <div class="tipo-item selected" onclick="toggleTipo('ejecucion', this)">
                    <input type="checkbox" id="tipo-ejecucion" checked>
                    <label>FRI Ejecuci√≥n (Mensual)</label>
                </div>
                <div class="tipo-item selected" onclick="toggleTipo('maquinaria', this)">
                    <input type="checkbox" id="tipo-maquinaria" checked>
                    <label>FRI Utilizaci√≥n de Maquinaria</label>
                </div>
                <div class="tipo-item selected" onclick="toggleTipo('regalias', this)">
                    <input type="checkbox" id="tipo-regalias" checked>
                    <label>FRI Regal√≠as (Trimestral)</label>
                </div>
            </div>

            <button onclick="buscarRegistros()" class="btn btn-primary" style="margin-top: 15px; font-size: 16px;">
                üîç BUSCAR REGISTROS
            </button>
        </div>

        <!-- PASO 3: VISTA PREVIA -->
        <div class="card">
            <h3>üëÅÔ∏è Paso 3: Vista Previa de Registros Encontrados</h3>
            <div id="registrosCount" style="margin-bottom: 15px; color: #666; font-size: 16px;">
                Presiona "BUSCAR REGISTROS" para ver los datos disponibles
            </div>
            <div id="previewContainer" class="preview">
                <p style="text-align: center; color: #999; padding: 40px;">
                    No se han buscado registros a√∫n
                </p>
            </div>
        </div>

        <!-- PASO 4: EXPORTACI√ìN -->
        <div class="card">
            <h3>üì• Paso 4: Exportar Datos</h3>
            
            <div class="form-group">
              <label>Formato de Exportaci√≥n:</label>
              <select id="formatoExportacion">
                  <option value="excel">Excel - Formato Simple (Columnas ANM)</option>
                  <option value="pdf">PDF - Reporte Ejecutivo</option>
              </select>
          </div>

            <button onclick="generarVistaPrevia()" class="btn btn-info" id="btnPreview" disabled>
                üëÅÔ∏è VER VISTA PREVIA DEL DOCUMENTO
            </button>

            <button onclick="exportarDatos()" class="btn btn-success" id="btnExport" disabled style="font-size: 16px; padding: 15px 30px;">
                üì• DESCARGAR ARCHIVO
            </button>
        </div>

        <!-- VISTA PREVIA DEL DOCUMENTO -->
        <div class="card" id="vistaPreview" style="display: none;">
            <h3>üìÑ Vista Previa del Documento a Exportar</h3>
            <div id="documentoPreview"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let authToken = localStorage.getItem('authToken');
        let registrosSeleccionados = [];
        let tiposSeleccionados = new Set(['produccion', 'inventarios', 'paradas', 'ejecucion', 'maquinaria', 'regalias']);

        window.onload = async () => {
            if (!authToken) {
                alert('‚ùå Debes iniciar sesi√≥n primero');
                window.location.href = 'test-all-fri.html';
                return;
            }

            await cargarTitulosMineros();
            await cargarUsuarios();
        };

        function toggleTipo(tipo, elemento) {
            const checkbox = elemento.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                elemento.classList.add('selected');
                tiposSeleccionados.add(tipo);
            } else {
                elemento.classList.remove('selected');
                tiposSeleccionados.delete(tipo);
            }
        }

        async function cargarTitulosMineros() {
            try {
                const response = await fetch(`${API_BASE}/titulos-mineros`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('tituloMinero');
                    data.titulos.forEach(titulo => {
                        const option = document.createElement('option');
                        option.value = titulo.id;
                        option.textContent = `${titulo.numeroTitulo} - ${titulo.municipio}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error al cargar t√≠tulos:', error);
            }
        }

        async function cargarUsuarios() {
            try {
                const response = await fetch(`${API_BASE}/usuarios`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('usuario');
                    data.usuarios.forEach(usuario => {
                        const option = document.createElement('option');
                        option.value = usuario.id;
                        option.textContent = usuario.nombre;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error al cargar usuarios:', error);
            }
        }

        async function buscarRegistros() {
    const previewDiv = document.getElementById('previewContainer');
    previewDiv.innerHTML = '<div class="loading">üîÑ Buscando registros...</div>';

    const filtros = construirFiltros();
    console.log('üîç Filtros construidos en frontend:', filtros);

    registrosSeleccionados = [];

    try {
        // Buscar en cada tipo seleccionado
        const promesas = [];

        console.log('üìã Tipos seleccionados:', Array.from(tiposSeleccionados));

        if (tiposSeleccionados.has('produccion')) {
            console.log('üìä Buscando en Producci√≥n...');
            promesas.push(buscarTipo('produccion', filtros));
        }
        if (tiposSeleccionados.has('inventarios')) {
            console.log('üìä Buscando en Inventarios...');
            promesas.push(buscarTipo('inventarios', filtros));
        }
        if (tiposSeleccionados.has('paradas')) {
            console.log('üìä Buscando en Paradas...');
            promesas.push(buscarTipo('paradas', filtros));
        }
        if (tiposSeleccionados.has('ejecucion')) {
            console.log('üìä Buscando en Ejecuci√≥n...');
            promesas.push(buscarTipo('ejecucion', filtros));
        }
        if (tiposSeleccionados.has('maquinaria')) {
            console.log('üìä Buscando en Maquinaria...');
            promesas.push(buscarTipo('maquinaria', filtros));
        }
        if (tiposSeleccionados.has('regalias')) {
            console.log('üìä Buscando en Regal√≠as...');
            promesas.push(buscarTipo('regalias', filtros));
        }

        await Promise.all(promesas);
        
        console.log('‚úÖ Total registros encontrados:', registrosSeleccionados.length);
        
        mostrarPreview();

    } catch (error) {
        console.error('‚ùå ERROR al buscar:', error);
        alert('‚ùå Error al buscar registros: ' + error.message);
        previewDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">Error al buscar registros</p>';
    }
}

        function construirFiltros() {
            const filtros = {};
            
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const tituloMineroId = document.getElementById('tituloMinero').value;
            const usuarioId = document.getElementById('usuario').value;
            const mineral = document.getElementById('mineral').value;
            const estado = document.getElementById('estado').value;

            if (fechaInicio) filtros.fechaInicio = fechaInicio;
            if (fechaFin) filtros.fechaFin = fechaFin;
            if (tituloMineroId) filtros.tituloMineroId = tituloMineroId;
            if (usuarioId) filtros.usuarioId = usuarioId;
            if (mineral) filtros.mineral = mineral;
            if (estado) filtros.estado = estado;

            return filtros;
        }

              async function buscarTipo(tipo, filtros) {
          const queryParams = new URLSearchParams(filtros);
          const url = `${API_BASE}/fri/${tipo}?${queryParams}`;
          
          console.log(`üåê Llamando a: ${url}`);
          
          const response = await fetch(url, {
              headers: { 'Authorization': `Bearer ${authToken}` }
          });

          console.log(`üì• Respuesta ${tipo}:`, response.status, response.statusText);

          const data = await response.json();
          
          console.log(`üìä Datos recibidos de ${tipo}:`, data);
          
          if (data.success && data.fris && data.fris.length > 0) {
              console.log(`‚úÖ ${tipo}: ${data.fris.length} registros`);
              registrosSeleccionados.push(...data.fris.map(f => ({
                  ...f,
                  tipoFormulario: tipo,
                  tipoNombre: obtenerNombreTipo(tipo)
              })));
          } else {
              console.log(`‚ö†Ô∏è ${tipo}: Sin registros`);
          }
      }

        function obtenerNombreTipo(tipo) {
            const nombres = {
                'produccion': 'Producci√≥n',
                'inventarios': 'Inventarios',
                'paradas': 'Paradas',
                'ejecucion': 'Ejecuci√≥n',
                'maquinaria': 'Maquinaria',
                'regalias': 'Regal√≠as'
            };
            return nombres[tipo] || tipo;
        }

        function mostrarPreview() {
            const countDiv = document.getElementById('registrosCount');
            const previewDiv = document.getElementById('previewContainer');
            const btnPreview = document.getElementById('btnPreview');
            const btnExport = document.getElementById('btnExport');

            if (registrosSeleccionados.length === 0) {
                countDiv.innerHTML = '‚ö†Ô∏è No se encontraron registros con los filtros seleccionados';
                previewDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No hay datos para mostrar</p>';
                btnPreview.disabled = true;
                btnExport.disabled = true;
                return;
            }

            countDiv.innerHTML = `‚úÖ <strong>${registrosSeleccionados.length}</strong> registro(s) encontrado(s) y listo(s) para exportar`;
            btnPreview.disabled = false;
            btnExport.disabled = false;

            // Agrupar por tipo
            const porTipo = {};
            registrosSeleccionados.forEach(reg => {
                if (!porTipo[reg.tipoFormulario]) {
                    porTipo[reg.tipoFormulario] = [];
                }
                porTipo[reg.tipoFormulario].push(reg);
            });

            let html = '';
            Object.entries(porTipo).forEach(([tipo, registros]) => {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">
                            üìã ${obtenerNombreTipo(tipo)} (${registros.length} registro${registros.length > 1 ? 's' : ''})
                        </h4>
                        ${registros.slice(0, 5).map(reg => `
                            <div class="preview-item">
                                <span class="badge badge-${reg.estado.toLowerCase()}">${reg.estado}</span>
                                <strong>ID:</strong> ${reg.id.substring(0, 8)} | 
                                <strong>Fecha:</strong> ${new Date(reg.fechaCorte).toLocaleDateString('es-CO')} |
                                <strong>Usuario:</strong> ${reg.usuario?.nombre || 'N/A'} |
                                <strong>T√≠tulo:</strong> ${reg.tituloMinero?.numeroTitulo || 'N/A'}
                                ${reg.mineral ? `| <strong>Mineral:</strong> ${reg.mineral}` : ''}
                            </div>
                        `).join('')}
                        ${registros.length > 5 ? `<p style="text-align: center; color: #666; margin-top: 10px;">... y ${registros.length - 5} m√°s</p>` : ''}
                    </div>
                `;
            });

            previewDiv.innerHTML = html;
        }

        function generarVistaPrevia() {
            const vistaDiv = document.getElementById('vistaPreview');
            const previewDiv = document.getElementById('documentoPreview');

            // Mostrar vista previa del documento
            vistaDiv.style.display = 'block';
            
            const formato = document.getElementById('formatoExportacion').value;
            
            let html = `
                <div class="vista-previa-documento">
                    <div class="documento-header">
                        <h4>üìÑ FORMATO OFICIAL ANM - FORMULARIO DE REPORTE DE INFORMACI√ìN (FRI)</h4>
                        <p style="color: #666; font-size: 14px;">Vista previa aproximada del documento a generar</p>
                    </div>

                    <div class="documento-info">
                        <strong>Fecha de generaci√≥n:</strong> ${new Date().toLocaleString('es-CO')}<br>
                        <strong>Total de registros:</strong> ${registrosSeleccionados.length}<br>
                        <strong>Formato:</strong> ${formato === 'excel-anm' ? 'Excel Oficial ANM' : 'Excel Consolidado'}
                    </div>
            `;

            // Agrupar por tipo
            const porTipo = {};
            registrosSeleccionados.forEach(reg => {
                if (!porTipo[reg.tipoFormulario]) {
                    porTipo[reg.tipoFormulario] = [];
                }
                porTipo[reg.tipoFormulario].push(reg);
            });

            Object.entries(porTipo).forEach(([tipo, registros]) => {
                html += `
                    <h4 style="color: #667eea; margin: 20px 0 10px 0;">
                        ${obtenerNombreTipo(tipo)} (${registros.length} registro${registros.length > 1 ? 's' : ''})
                    </h4>
                    <div class="preview-table">
                        <table>
                            <thead>
                                <tr>
                                    ${generarEncabezadosTabla(tipo)}
                                </tr>
                            </thead>
                            <tbody>
                                ${registros.slice(0, 10).map(reg => generarFilaTabla(tipo, reg)).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${registros.length > 10 ? `<p style="text-align: center; color: #666; margin-top: 5px; font-size: 12px;">... y ${registros.length - 10} registros m√°s en el archivo final</p>` : ''}
                `;
            });

            html += '</div>';
            previewDiv.innerHTML = html;

            // Scroll a la vista previa
            vistaDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function generarEncabezadosTabla(tipo) {
            const headers = {
                'produccion': '<th>Fecha</th><th>Mineral</th><th>T√≠tulo</th><th>Horas</th><th>Cantidad</th><th>Unidad</th><th>Estado</th>',
                'inventarios': '<th>Fecha</th><th>Mineral</th><th>Inv. Inicial</th><th>Ingreso</th><th>Salida</th><th>Inv. Final</th><th>Estado</th>',
                'paradas': '<th>Fecha</th><th>Tipo Parada</th><th>Inicio</th><th>Fin</th><th>Horas</th><th>Motivo</th><th>Estado</th>',
                'ejecucion': '<th>Fecha</th><th>Mineral</th><th>Frente</th><th>M√©todo</th><th>Avance</th><th>Volumen</th><th>Estado</th>',
                'maquinaria': '<th>Fecha</th><th>Tipo</th><th>Cantidad</th><th>Horas</th><th>Capacidad</th><th>Estado</th>',
                'regalias': '<th>Fecha</th><th>Mineral</th><th>Cantidad</th><th>Unidad</th><th>Valor Declaraci√≥n</th><th>Estado</th>'
            };
            return headers[tipo] || '<th>Datos</th>';
        }

        function generarFilaTabla(tipo, reg) {
            const filas = {
                'produccion': `
                    <td>${new Date(reg.fechaCorte).toLocaleDateString('es-CO')}</td>
                    <td>${reg.mineral || 'N/A'}</td>
                    <td>${reg.tituloMinero?.numeroTitulo || 'N/A'}</td>
                    <td>${reg.horasOperativas || 0}</td>
                    <td>${reg.cantidadProduccion || 0}</td>
                    <td>${reg.unidadMedida || 'N/A'}</td>
                    <td><span class="badge badge-${reg.estado.toLowerCase()}">${reg.estado}</span></td>
                `,
                'inventarios': `
                    <td>${new Date(reg.fechaCorte).toLocaleDateString('es-CO')}</td>
                    <td>${reg.mineral || 'N/A'}</td>
                    <td>${reg.inventarioInicialAcopio || 0}</td>
                    <td>${reg.ingresoAcopio || 0}</td>
                    <td>${reg.salidaAcopio || 0}</td>
                    <td>${reg.inventarioFinalAcopio || 0}</td>
                    <td><span class="badge badge-${reg.estado.toLowerCase()}">${reg.estado}</span></td>
                `,
                'paradas': `
                    <td>${new Date(reg.fechaCorte).toLocaleDateString('es-CO')}</td>
                    <td>${reg.tipoParada || 'N/A'}</td>
                    <td>${new Date(reg.fechaInicio).toLocaleString('es-CO', {dateStyle: 'short', timeStyle: 'short'})}</td>
                    <td>${reg.fechaFin ? new Date(reg.fechaFin).toLocaleString('es-CO', {dateStyle: 'short', timeStyle: 'short'}) : 'En curso'}</td>
                    <td>${reg.horasParadas || 0}</td>
                    <td>${(reg.motivo || '').substring(0, 30)}...</td>
                    <td><span class="badge badge-${reg.estado.toLowerCase()}">${reg.estado}</span></td>
                `
            };
            return `<tr>${filas[tipo] || '<td>Datos no disponibles</td>'}</tr>`;
        }

        async function exportarDatos() {
    if (registrosSeleccionados.length === 0) {
        alert('‚ùå No hay registros para exportar');
        return;
    }

    const formato = document.getElementById('formatoExportacion').value;
    const endpoint = formato === 'pdf' ? 
        `${API_BASE}/reportes/exportar-pdf` : 
        `${API_BASE}/reportes/exportar-anm`;
    
    const extension = formato === 'pdf' ? 'pdf' : 'xlsx';
    
    // ‚úÖ AGREGAR ESTOS LOGS
    const payload = {
        tipos: Array.from(tiposSeleccionados),
        filtros: construirFiltros()
    };
    
    console.log('üì§ PAYLOAD COMPLETO:', payload);
    console.log('üì§ Tipos:', payload.tipos);
    console.log('üì§ Filtros:', payload.filtros);
    console.log('üåê Endpoint:', endpoint);
    
    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(payload)  // ‚úÖ Usar la variable payload
        });

        console.log('üì• Status:', response.status);
        console.log('üì• Status Text:', response.statusText);

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FRI_ANM_${Date.now()}.${extension}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            
            alert(`‚úÖ Archivo ${extension.toUpperCase()} descargado correctamente`);
        } else {
            const error = await response.json();
            console.error('‚ùå Error del servidor:', error);
            alert('‚ùå Error: ' + error.message);
        }

    } catch (error) {
        console.error('‚ùå Error completo:', error);
        alert('‚ùå Error al exportar: ' + error.message);
    }
}

        const formato = document.getElementById('formatoExportacion').value;
        const endpoint = formato === 'pdf' ? 
            `${API_BASE}/reportes/exportar-pdf` : 
            `${API_BASE}/reportes/exportar-anm`;
        
        const extension = formato === 'pdf' ? 'pdf' : 'xlsx';
        
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    tipos: Array.from(tiposSeleccionados),
                    formato: formato,
                    filtros: construirFiltros()
                })
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `FRI_ANM_${Date.now()}.${extension}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                
                alert(`‚úÖ Archivo ${extension.toUpperCase()} descargado correctamente`);
            } else {
                const error = await response.json();
                alert('‚ùå Error: ' + error.message);
            }

        } catch (error) {
            alert('‚ùå Error al exportar: ' + error.message);
        }
    

        function limpiarFiltros() {
            document.getElementById('fechaInicio').value = '';
            document.getElementById('fechaFin').value = '';
            document.getElementById('tituloMinero').value = '';
            document.getElementById('usuario').value = '';
            document.getElementById('mineral').value = '';
            document.getElementById('estado').value = '';
            
            registrosSeleccionados = [];
            document.getElementById('previewContainer').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No se han buscado registros a√∫n</p>';
            document.getElementById('registrosCount').innerHTML = 'Presiona "BUSCAR REGISTROS" para ver los datos disponibles';
            document.getElementById('btnPreview').disabled = true;
            document.getElementById('btnExport').disabled = true;
            document.getElementById('vistaPreview').style.display = 'none';
        }
    </script>
</body>
</html>